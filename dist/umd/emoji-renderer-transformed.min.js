!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).EMOJI=t.EMOJI||{})}(this,(function(t){"use strict";t.TransformedRenderer=class extends class{measureCanvas;measureContext;canvasCache={};measureCache={};options={targetWidth:600,bgcolor:!1,color:null,font:"sans-serif",alphaThreshold:0};constructor(t={}){this.options={...this.options,...t},this.measureCanvas=document.createElement("canvas"),this.measureContext=this.measureCanvas.getContext("2d")}measureCanvasContextContent(t,e,a=0){let i,s={left:!1,top:!1,right:!1,bottom:!1},r=parseInt(t.canvas.getAttribute("width"),10),n=parseInt(t.canvas.getAttribute("height"),10);const o=(t,e)=>(e+1)%4==0?t>a:t>0;for(i=0;i<.5*r&&(!s.left||!s.right);i++){if(!s.left){t.getImageData(i,0,1,n).data.filter(o).length>0&&(s.left=Math.max(0,i-1))}if(!s.right){t.getImageData(r-i,0,1,n).data.filter(o).length>0&&(s.right=Math.min(r,i-1))}}for(i=0;i<.5*n&&(!s.top||!s.bottom);i++){if(!s.top){t.getImageData(0,i,r,1).data.filter(o).length>0&&(s.top=Math.max(0,i-1))}if(!s.bottom){t.getImageData(0,n-i,r,1).data.filter(o).length>0&&(s.bottom=Math.min(n,i-1))}}let h=n-s.top-s.bottom,l=r-s.right-s.left,c=e||l,u=h,d=c*u/(l*h);return e&&(c=e,u=h*d),{bounds:s,scaleFactor:d,dims:{width:c,height:u},actualDims:{width:l,height:h}}}measure(t){const e=this.normalize(t);if(e in this.measureCache)return this.measureCache[e];const a=100,i=150;this.measureCanvas.width=i,this.measureCanvas.height=i,this.measureContext.clearRect(0,0,i,i),this.measureContext.font="100px "+t.font,this.measureContext.textBaseline="middle",this.measureContext.textAlign="center",this.measureContext.fillText(t.emoji,75,75);let s=this.measureCanvasContextContent(this.measureContext,t.targetWidth,t.alphaThreshold),r=s.scaleFactor*a;return this.measureCache[e]={width:s.dims.width,height:s.dims.height,targetFontSize:r,yOffset:(75-.5*s.actualDims.height-s.bounds.top)/s.actualDims.height,xOffset:(75-.5*s.actualDims.width-s.bounds.left)/s.actualDims.width},this.measureCache[e]}render(t){t=this.normalizeInput(t);const e=this.normalize(t);if(e in this.canvasCache)return this.canvasCache[e];let a=document.createElement("canvas");const i=a.getContext("2d"),s=this.measure(t);a.setAttribute("width",s.width),a.setAttribute("height",s.height),i.clearRect(0,0,s.width,s.height),i.font=`${Math.round(s.targetFontSize)}px ${t.font}`,i.textAlign="center",i.textBaseline="middle";const r={x:.5*s.width+s.width*s.xOffset,y:.5*s.height+s.height*s.yOffset};return t.color&&(i.fillStyle=t.color),i.fillText(t.emoji,r.x,r.y),"BaseRenderer"===this.constructor.name&&(a=this.fillBackground(a,t.bgcolor)),this.canvasCache[e]=a,this.canvasCache[e]}fillBackground(t,e){if(!e||"transparent"===e||""===e)return t;const a=document.createElement("canvas"),i=a.getContext("2d"),s=t.getAttribute("width"),r=t.getAttribute("height");return a.setAttribute("width",s),a.setAttribute("height",r),i.beginPath(),i.fillStyle=e,i.fillRect(0,0,s,r),i.fill(),i.closePath(),i.drawImage(t,0,0),a}normalize(t){if((t=this.normalizeInput(t)).isError)return"PARSE_ERROR";let e=t.emoji+"_",a=[];for(const e in t)"emoji"!==e&&a.push([e,t[e]]);a.sort(((t,e)=>t[0]>e[0]?1:-1));for(const[t,i]of a){let t=String(i);[["true","t"],["false","f"],["null","n"],["sans-serif","ss"],["inside","is"],["outside","os"]].forEach((e=>t=t.replace(e[0],e[1])));for(let a=0;a<t.length;a++){const i=t.charCodeAt(a);e+=i>=48&&i<=57||i>=65&&i<=90||i>=61&&i<=122?t[a]:t.charCodeAt(a).toString(16)}}return e}normalizeInput(t){let e;if("object"==typeof t)e=t;else if("{"===t[0])try{e=JSON.parse(t)}catch(a){e={emoji:"�️",isBasicEmoji:!0,isError:!0},console.error("JSON PARSE failed on data-emoji='"+t+"'")}else e={isBasicEmoji:!0,emoji:t};e.targetWidth=e.targetWidth||this.options.targetWidth;for(const t in this.options)t in e||(e[t]=this.options[t]);return e}}{constructor(t={}){super({scale:1,rotate:null,crop:!0,...t})}render(t){if((t=this.normalizeInput(t)).isError)return super.render(t);const e=this.normalize(t);if(e in this.canvasCache)return this.canvasCache[e];const a=super.render(t),i=t.scaleX||t.scale||1,s=t.scaleY||t.scale||1,r=parseInt(a.getAttribute("width"),10),n=parseInt(a.getAttribute("height"),10),o=r*i,h=n*s;let l=document.createElement("canvas"),c=l.getContext("2d");if(l.setAttribute("width",o),l.setAttribute("height",h),"rotate"in t){const e="string"==typeof t.rotate?parseFloat(t.rotate)*Math.PI/180:t.rotate,i={tl:{x:0,y:0},tr:{x:o,y:0},br:{x:o,y:h},bl:{x:0,y:h}},s={};for(const t in i){const a=.5*o,r=.5*h,n=i[t].x,l=i[t].y;s[t]={x:a+(n-a)*Math.cos(-e)+(l-r)*Math.sin(-e),y:r-(n-a)*Math.sin(-e)+(l-r)*Math.cos(-e)}}const u=Math.min(s.tl.x,s.tr.x,s.bl.x,s.br.x),d=Math.max(s.tl.x,s.tr.x,s.bl.x,s.br.x),m=Math.min(s.tl.y,s.tr.y,s.bl.y,s.br.y),f=o+(d-o)-u,g=h+(Math.max(s.tl.y,s.tr.y,s.bl.y,s.br.y)-h)-m;l.setAttribute("width",f),l.setAttribute("height",g),c.save(),c.translate(.5*f,.5*g),c.rotate(e),c.drawImage(a,0,0,r,n,-.5*o,-.5*h,o,h),c.restore()}else c.drawImage(a,0,0,r,n,0,0,o,h);return!0===t.crop&&(l=this.cropCanvas(l,t.targetWidth,t.alphaThreshold)),"TransformedRenderer"===this.constructor.name&&(l=this.fillBackground(l,t.bgcolor)),this.canvasCache[e]=l,this.canvasCache[e]}cropCanvas(t,e,a){const i=t.getContext("2d"),s=this.measureCanvasContextContent(i,e,a),r=document.createElement("canvas"),n=r.getContext("2d");return r.setAttribute("width",s.actualDims.width),r.setAttribute("height",s.actualDims.height),n.drawImage(t,s.bounds.left,s.bounds.top,s.actualDims.width,s.actualDims.height,0,0,s.actualDims.width,s.actualDims.height),r}},Object.defineProperty(t,"__esModule",{value:!0})}));