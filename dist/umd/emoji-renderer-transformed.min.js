!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).EMOJI=t.EMOJI||{})}(this,(function(t){"use strict";t.TransformedRenderer=class extends class{measureCanvas;measureContext;canvasCache={};measureCache={};options={targetWidth:600,bgcolor:!1,color:null,font:"sans-serif",fontSize:null,alphaThreshold:0};constructor(t={}){this.options={...this.options,...t},this.measureCanvas=document.createElement("canvas"),this.measureContext=this.measureCanvas.getContext("2d")}measureCanvasContextContent(t,e,a=0){let i,s={left:!1,top:!1,right:!1,bottom:!1},r=parseInt(t.canvas.getAttribute("width"),10),n=parseInt(t.canvas.getAttribute("height"),10);const o=navigator.brave?1:0,h=(t,e)=>(e+1)%4==0?t>a:t>o;for(i=0;i<.5*r&&(!s.left||!s.right);i++){if(!s.left){t.getImageData(i,0,1,n).data.filter(h).length>0&&(s.left=Math.max(0,i-1))}if(!s.right){t.getImageData(r-i,0,1,n).data.filter(h).length>0&&(s.right=Math.min(r,i-1))}}for(i=0;i<.5*n&&(!s.top||!s.bottom);i++){if(!s.top){t.getImageData(0,i,r,1).data.filter(h).length>0&&(s.top=Math.max(0,i-1))}if(!s.bottom){t.getImageData(0,n-i,r,1).data.filter(h).length>0&&(s.bottom=Math.min(n,i-1))}}let l=n-s.top-s.bottom,c=r-s.right-s.left,u=e||c,d=l,m=u*d/(c*l);return e&&(u=e,d=l*m),{bounds:s,scaleFactor:m,dims:{width:u,height:d},actualDims:{width:c,height:l}}}measure(t){const e=this.normalize(t);if(e in this.measureCache)return this.measureCache[e];const a=parseInt(t.fontSize||100,10),i=a+.5*a;this.measureCanvas.width=i,this.measureCanvas.height=i,this.measureContext.clearRect(0,0,i,i),this.measureContext.font=a+"px "+t.font,this.measureContext.textBaseline="middle",this.measureContext.textAlign="center",this.measureContext.fillText(t.emoji,.5*i,.5*i);let s=this.measureCanvasContextContent(this.measureContext,t.targetWidth,t.alphaThreshold),r=s.scaleFactor*a;return t.fontSize&&(r=t.fontSize),this.measureCache[e]={width:s.dims.width,height:s.dims.height,targetFontSize:r,yOffset:(.5*i-.5*s.actualDims.height-s.bounds.top)/s.actualDims.height,xOffset:(.5*i-.5*s.actualDims.width-s.bounds.left)/s.actualDims.width},this.measureCache[e]}render(t){t=this.normalizeInput(t);const e=this.normalize(t);if(e in this.canvasCache)return this.canvasCache[e];let a=document.createElement("canvas");const i=a.getContext("2d"),s=this.measure(t);a.setAttribute("width",s.width),a.setAttribute("height",s.height),i.clearRect(0,0,s.width,s.height),i.font=`${Math.round(s.targetFontSize)}px ${t.font}`,i.textAlign="center",i.textBaseline="middle";const r={x:.5*s.width+s.width*s.xOffset,y:.5*s.height+s.height*s.yOffset};return t.color&&(i.fillStyle=t.color),i.fillText(t.emoji,r.x,r.y),"BaseRenderer"===this.constructor.name&&(a=this.fillBackground(a,t.bgcolor)),this.canvasCache[e]=a,this.canvasCache[e]}fillBackground(t,e){if(!e||"transparent"===e||""===e)return t;const a=document.createElement("canvas"),i=a.getContext("2d"),s=t.getAttribute("width"),r=t.getAttribute("height");return a.setAttribute("width",s),a.setAttribute("height",r),i.beginPath(),i.fillStyle=e,i.fillRect(0,0,s,r),i.fill(),i.closePath(),i.drawImage(t,0,0),a}normalize(t){if((t=this.normalizeInput(t)).isError)return"PARSE_ERROR";let e=t.emoji+"_",a=[];for(const e in t)"emoji"!==e&&a.push([e,t[e]]);a.sort(((t,e)=>t[0]>e[0]?1:-1));for(const[t,i]of a){let t=String(i);[["true","t"],["false","f"],["null","n"],["sans-serif","ss"],["inside","is"],["outside","os"]].forEach((e=>t=t.replace(e[0],e[1])));for(let a=0;a<t.length;a++){const i=t.charCodeAt(a);e+=i>=48&&i<=57||i>=65&&i<=90||i>=61&&i<=122?t[a]:t.charCodeAt(a).toString(16)}}return e}normalizeInput(t){let e;if("object"==typeof t)e=t;else if("{"===t[0])try{e=JSON.parse(t)}catch(a){e={emoji:"�️",isBasicEmoji:!0,isError:!0},console.error("JSON PARSE failed on data-emoji='"+t+"'")}else e={isBasicEmoji:!0,emoji:t};e.targetWidth=e.targetWidth||this.options.targetWidth;for(const t in this.options)t in e||(e[t]=this.options[t]);return e}}{constructor(t={}){super({scale:1,rotate:null,crop:!0,...t})}render(t){if((t=this.normalizeInput(t)).isError)return super.render(t);const e=this.normalize(t);if(e in this.canvasCache)return this.canvasCache[e];const a=super.render(t),i=t.scale||1,s=parseInt(a.getAttribute("width"),10),r=parseInt(a.getAttribute("height"),10),n=s*i,o=r*i;let h=document.createElement("canvas"),l=h.getContext("2d");if(h.setAttribute("width",n),h.setAttribute("height",o),"rotate"in t){const e="string"==typeof t.rotate?parseFloat(t.rotate)*Math.PI/180:t.rotate,i={tl:{x:0,y:0},tr:{x:n,y:0},br:{x:n,y:o},bl:{x:0,y:o}},c={};for(const t in i){const a=.5*n,s=.5*o,r=i[t].x,h=i[t].y;c[t]={x:a+(r-a)*Math.cos(-e)+(h-s)*Math.sin(-e),y:s-(r-a)*Math.sin(-e)+(h-s)*Math.cos(-e)}}const u=Math.min(c.tl.x,c.tr.x,c.bl.x,c.br.x),d=Math.max(c.tl.x,c.tr.x,c.bl.x,c.br.x),m=Math.min(c.tl.y,c.tr.y,c.bl.y,c.br.y),f=n+(d-n)-u,g=o+(Math.max(c.tl.y,c.tr.y,c.bl.y,c.br.y)-o)-m;h.setAttribute("width",f),h.setAttribute("height",g),l.save(),l.translate(.5*f,.5*g),l.rotate(e),l.drawImage(a,0,0,s,r,-.5*n,-.5*o,n,o),l.restore()}else l.drawImage(a,0,0,s,r,0,0,n,o);return!0===t.crop&&(h=this.cropCanvas(h,t.targetWidth,t.alphaThreshold)),"TransformedRenderer"===this.constructor.name&&(h=this.fillBackground(h,t.bgcolor)),this.canvasCache[e]=h,this.canvasCache[e]}cropCanvas(t,e,a){const i=t.getContext("2d"),s=this.measureCanvasContextContent(i,e,a),r=document.createElement("canvas"),n=r.getContext("2d");return r.setAttribute("width",s.actualDims.width),r.setAttribute("height",s.actualDims.height),n.drawImage(t,s.bounds.left,s.bounds.top,s.actualDims.width,s.actualDims.height,0,0,s.actualDims.width,s.actualDims.height),r}},Object.defineProperty(t,"__esModule",{value:!0})}));