!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).EMOJI=e.EMOJI||{})}(this,(function(e){"use strict";e.ComposedCSSHelper=class extends class{processedEmojis=[];options={selectorPrefix:"",selectorSuffix:"",propertyGenerator:e=>`background-image:url("${e}");`,selectorGenerator:(e,t,o,s)=>`${o}[data-emojikey="${t}"]${s}`,selectorPropertyAttacher:(e,t)=>{e.dataset.emojikey=t},targetNode:document.body,styleParentNode:document.head,onRender:null,onDeploy:null,useCache:!0,cacheName:"emoji",imageFormat:"image/png",imageQuality:1,logTiming:!1,setDimensions:!1,emojis:[],deployOnConstruct:!0};styleNode=null;renderer=null;cacheSupported=!1;cache=null;ready=!0;timings=[];constructor(e,t){this.options={...this.options,...e},t?(this.renderer=t,this.cacheSupported="caches"in window,!this.cacheSupported&&this.options.useCache&&"http:"===window.location.protocol&&console.error("Cache not supported on non-ssl URLs"),this.cacheSupported&&this.options.useCache?(this.ready=!1,caches.open(this.options.cacheName).then((e=>{this.cache=e,this.ready=!0,this.options.deployOnConstruct&&this.deploy()}))):this.options.deployOnConstruct&&this.deploy()):console.error("renderer argument missing")}parseDataAttributes(e){let t=e.dataset,o=Object.keys(t).filter((e=>"emoji"===e.substr(0,5))),s=t.emoji,i={emoji:s};return 1===o.length?s:(["bgcolor","color","font","target-width","scale","rotate","crop","pixelate","outline","outline-color","outline-mode"].forEach((e=>{const s="emoji"+e.replace(/(^\w)|-(\w)/g,(e=>e.slice(-1).toUpperCase()));if(o.indexOf(s)>-1){let e=String(s).replace(/^emoji/,"").replace(/^\w/,(e=>e.toLowerCase()));i[e]=t[s]}})),i)}deploy(){if(0===this.timings.length&&(this.timings[0]=Date.now()),!this.ready)return console.log("helper not ready... most likely some cache issue, waiting for cache to become ready"),setTimeout(this.deploy.bind(this),15);let e=Array.from(this.options.targetNode.querySelectorAll("[data-emoji]"));this.options.emojis.forEach((t=>{"string"!=typeof t&&(t=JSON.stringify(t));const o=document.createElement("div");o.dataset.emoji=t,e.push(o)})),this.options.emojis=[],e.forEach((e=>{if(e.dataset.emojikey)return!0;const t=this.renderer.normalizeInput(this.parseDataAttributes(e)),o=this.renderer.normalize(t),s=this.options.selectorGenerator(t,o,this.options.selectorPrefix,this.options.selectorSuffix);if(this.options.selectorPropertyAttacher(e,o),o in this.processedEmojis)return!0;this.processedEmojis[o]=!0,"PARSE_ERROR"===o&&(e.dataset.originalEmoji=e.dataset.emoji,e.dataset.emoji="PARSE_ERROR"),this.options.useCache&&this.cacheSupported&&"PARSE_ERROR"!==o?this.cache.match(this.cacheURI(o)).then((e=>e.blob())).then((e=>{this.createCSSRule(s,URL.createObjectURL(e));const t={instance:this,key:o,cached:!0,renderer:this.renderer};this.options.onRender&&this.options.onRender(t),this.options.targetNode.dispatchEvent(new CustomEvent("emoji:rendered",{detail:t,bubbles:!0}))})).catch((e=>{this.createEmojiBitmap(s,t,o)})):this.createEmojiBitmap(s,t,o)}))}createEmojiBitmap(e,t,o){this.renderer.render(t).toBlob((t=>{this.setCache(o,t),this.createCSSRule(e.trim(),URL.createObjectURL(t));const s={instance:this,key:o,cached:!1,renderer:this.renderer,canvas:this.renderer.canvasCache[o]};this.options.onRender&&this.options.onRender(s),this.options.targetNode.dispatchEvent(new CustomEvent("emoji:rendered",{detail:s,bubbles:!0}))}))}createCSSRule(e,t){if(this.styleNode||(this.styleNode=document.createElement("style"),this.options.styleParentNode.appendChild(this.styleNode)),this.options.setDimensions){const o=document.createElement("img");o.addEventListener("load",function(e,t,o,s){return function(i){o.insertRule(`${e}{ ${t}; width : ${i.target.width}px; height : ${i.target.height}px; }`),s()}}(e,this.options.propertyGenerator(t),this.styleNode.sheet,this.emitDeployEvent.bind(this))),o.setAttribute("src",t)}else this.styleNode.sheet.insertRule(`${e}{${this.options.propertyGenerator(t)}}`),this.emitDeployEvent()}emitDeployEvent(){let e=Object.keys(this.processedEmojis).length;if(this.styleNode.sheet.cssRules.length<e)return;this.timings.push(Date.now()),this.options.logTiming&&console.log(`last deploy() call took ${this.timings.slice(-1)-this.timings.slice(-2,-1)}ms`);const t={instance:this,timings:this.timings};this.options.onDeploy&&this.options.onRender(t),this.options.targetNode.dispatchEvent(new CustomEvent("emoji:deployed",{detail:t,bubbles:!0})),this.timings=[]}setCache(e,t){if("PARSE_ERROR"===e||!this.options.useCache||!this.cacheSupported)return!1;this.cache.put(this.cacheURI(e),new Response(t))}cacheURI(e){const t=window.location.pathname,o=this.options.imageFormat.split("/").pop();return t.substring(0,t.lastIndexOf("/"))+"/emoji/"+e+"."+o}}{usedCompositionKeys={};constructor(e={},t){const o={key:"DEFAULT",width:400,height:400,bgmode:"solid",bgcolor:"#ffffff",...e.defaultCompositionProperties},s={emoji:"e",top:"50%",left:"50%",translateX:"-50%",translateY:"-50%",...e.defaultEmojiProperties};super({localDeployOnConstruct:e.deployOnConstruct||!0,selectorGenerator:(e,t,o,s)=>`${o}.emojicomp_${t}${s}, ${o}[data-compose-key="${t}"]${s}`,compositions:[],positionSnap:0,...e,defaultCompositionProperties:o,defaultEmojiProperties:s,deployOnConstruct:!1},t),this.options.localDeployOnConstruct&&this.deploy()}parseComposeDataAttributes(e){let t=Object.keys(e.dataset).filter((e=>"compose"===e.substr(0,7))),o={emojis:[]};return t.forEach((t=>{if(/-\d+/.test(t)){const s=/\-(\d+)([\w\-]+)/.exec(t),i=parseInt(s[1],10),n=s[2].replace(/^\w/,(e=>e[0].toLowerCase()));o.emojis[i]||(o.emojis[i]={}),"emoji"===n&&"{"===e.dataset[t].slice(0,1)?o.emojis[i]=JSON.parse(e.dataset[t]):o.emojis[i][n]=e.dataset[t]}else o[t.substr(7).toLowerCase()]=e.dataset[t]})),this.expandComposition(o)}expandComposition(e){return e.key?e.key in this.usedCompositionKeys?(console.log(`composition key already used. @${e.key}`),!1):(this.usedCompositionKeys[e.key]=!0,(e={...this.options.defaultCompositionProperties,...e}).emojis=e.emojis.map((e=>("string"==typeof e&&(e={emoji:e}),{...this.options.defaultEmojiProperties,...e}))),e):(console.log(`composition key must not be empty. @${JSON.stringify(e)}`),!1)}normalizePosition(e,t){const o="string"==typeof e&&/%$/.test(e);let s=parseFloat(e);return o&&Math.abs(s)>1?s*=.01:!o&&Math.abs(s)>1&&(s/=t),this.options.positionSnap>0?Math.floor(s*t/this.options.positionSnap)*this.options.positionSnap:s*t}deploy(){if(super.deploy(),!this.ready)return;let e=Array.from(this.options.targetNode.querySelectorAll("[data-compose-key]")).map((e=>this.parseComposeDataAttributes(e)));this.options.compositions.forEach((t=>e.push(this.expandComposition(t)))),e=e.filter((e=>!!e)),e.forEach((e=>{const t=`${e.key}`,o=this.options.selectorGenerator(null,t,this.options.selectorPrefix,this.options.selectorSuffix);this.cache&&this.options.useCache&&this.cacheSupported?this.cache.match(this.cacheURI(t)).then((e=>e.blob())).then((e=>{this.createCSSRule(o,URL.createObjectURL(e));const s={instance:this,key:t,cached:!0,renderer:this.renderer};this.options.onRender&&this.options.onRender(s),this.options.targetNode.dispatchEvent(new CustomEvent("emoji:rendered",{detail:s,bubbles:!0}))})).catch((s=>{this.createComposition(o,e,t)})):(this.createComposition(o,e,t),console.log(o))}))}createComposition(e,t,o){const s=document.createElement("canvas"),i=s.getContext("2d");s.setAttribute("width",t.width),s.setAttribute("height",t.height),"solid"===t.bgmode&&(i.beginPath(),i.fillStyle=t.bgcolor,i.fillRect(0,0,t.width,t.height),i.fill(),i.closePath()),t.emojis.forEach((e=>{const o=this.renderer.render({...e,targetWidth:t.width}),s=parseInt(o.getAttribute("width"),10),n=parseInt(o.getAttribute("height"),10),r=this.normalizePosition(e.left,t.width)+this.normalizePosition(e.translateX,s),a=this.normalizePosition(e.top,t.height)+this.normalizePosition(e.translateY,n);i.drawImage(o,r,a)})),s.toBlob((t=>{this.setCache(o,t),this.createCSSRule(e.trim(),URL.createObjectURL(t))}))}},Object.defineProperty(e,"__esModule",{value:!0})}));