!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).EMOJI=e.EMOJI||{})}(this,(function(e){"use strict";e.CSSHelper=class{processedEmojis=[];options={selectorPrefix:"",selectorSuffix:"",propertyGenerator:e=>`background-image:url("${e}");`,targetNode:document.body,styleParentNode:document.head,onRender:null,onDeploy:null,useCache:!0,cacheName:"emoji",imageFormat:"image/png",imageQuality:1,logTiming:!1,setDimensions:!1};styleNode=null;renderer=null;cacheSupported=!1;cache=null;ready=!0;timings=[];constructor(e,t){this.options={...this.options,...e},t?(this.renderer=t,this.cacheSupported="caches"in window,!this.cacheSupported&&this.options.useCache&&"http:"===window.location.protocol&&console.error("Cache not supported on non-ssl URLs"),this.cacheSupported&&this.options.useCache?(this.ready=!1,caches.open(this.options.cacheName).then((e=>{this.cache=e,this.ready=!0,this.deploy()}))):this.deploy()):console.error("renderer argument missing")}parseDataAttributes(e){let t=e.dataset,i=Object.keys(t).filter((e=>"emoji"===e.substr(0,5))),s=t.emoji,o={emoji:s};return 1===i.length?s:(["bgcolor","scale","rotate","crop","pixelate","outline","outline-color","outline-mode"].forEach((e=>{const s="emoji"+e.replace(/(^\w)|-(\w)/g,(e=>e.slice(-1).toUpperCase()));if(i.indexOf(s)>-1){let e=String(s).replace(/^emoji/,"").replace(/^\w/,(e=>e.toLowerCase()));o[e]=t[s]}})),o)}deploy(){if(0===this.timings.length&&(this.timings[0]=Date.now()),!this.ready)return console.log("helper not ready... most likely some cache issue, waiting for cache to become ready"),setTimeout(this.deploy.bind(this),15);this.options.targetNode.querySelectorAll("[data-emoji]").forEach((e=>{if(e.dataset.emojikey)return!0;const t=this.renderer.normalizeInput(this.parseDataAttributes(e)),i=this.renderer.normalize(t),s=`${this.options.selectorPrefix}[data-emojikey="${i}"]${this.options.selectorSuffix}`;if(e.dataset.emojikey=i,i in this.processedEmojis)return!0;this.processedEmojis[i]=!0,"PARSE_ERROR"===i&&(e.dataset.originalEmoji=e.dataset.emoji,e.dataset.emoji="PARSE_ERROR"),this.options.useCache&&this.cacheSupported&&"PARSE_ERROR"!==i?this.cache.match(this.cacheURI(i)).then((e=>e.blob())).then((e=>{this.createCSSRule(s,URL.createObjectURL(e));const t={instance:this,key:i,cached:!0,renderer:this.renderer};this.options.onRender&&this.options.onRender(t),this.options.targetNode.dispatchEvent(new CustomEvent("emoji:rendered",{detail:t,bubbles:!0}))})).catch((e=>{this.createEmojiBitmap(s,t,i)})):this.createEmojiBitmap(s,t,i)}))}createEmojiBitmap(e,t,i){this.renderer.render(t).toBlob((t=>{this.setCache(i,t),this.createCSSRule(e.trim(),URL.createObjectURL(t));const s={instance:this,key:i,cached:!1,renderer:this.renderer,canvas:this.renderer.canvasCache[i]};this.options.onRender&&this.options.onRender(s),this.options.targetNode.dispatchEvent(new CustomEvent("emoji:rendered",{detail:s,bubbles:!0}))}))}createCSSRule(e,t){if(this.styleNode||(this.styleNode=document.createElement("style"),this.options.styleParentNode.appendChild(this.styleNode)),this.options.setDimensions){const i=document.createElement("img");i.addEventListener("load",function(e,t,i,s){return function(o){i.insertRule(`${e}{ ${t}; width : ${o.target.width}px; height : ${o.target.height}px; }`),s()}}(e,this.options.propertyGenerator(t),this.styleNode.sheet,this.emitDeployEvent.bind(this))),i.setAttribute("src",t)}else this.styleNode.sheet.insertRule(`${e}{${this.options.propertyGenerator(t)}}`),this.emitDeployEvent()}emitDeployEvent(){let e=Object.keys(this.processedEmojis).length;if(this.styleNode.sheet.cssRules.length<e)return;this.timings.push(Date.now()),this.options.logTiming&&console.log(`last deploy() call took ${this.timings.slice(-1)-this.timings.slice(-2,-1)}ms`);const t={instance:this,timings:this.timings};this.options.onDeploy&&this.options.onRender(t),this.options.targetNode.dispatchEvent(new CustomEvent("emoji:deployed",{detail:t,bubbles:!0})),this.timings=[]}setCache(e,t){if("PARSE_ERROR"===e||!this.options.useCache||!this.cacheSupported)return!1;this.cache.put(this.cacheURI(e),new Response(t))}cacheURI(e){const t=window.location.pathname,i=this.options.imageFormat.split("/").pop();return t.substring(0,t.lastIndexOf("/"))+"/emoji/"+e+"."+i}},Object.defineProperty(e,"__esModule",{value:!0})}));