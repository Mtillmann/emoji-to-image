!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).EMOJI=t.EMOJI||{})}(this,(function(t){"use strict";t.DecoratedRenderer=class extends class extends class{measureCanvas;measureContext;canvasCache={};measureCache={};options={targetWidth:600,bgcolor:!1,color:null,font:"sans-serif",alphaThreshold:0};constructor(t={}){this.options={...this.options,...t},this.measureCanvas=document.createElement("canvas"),this.measureContext=this.measureCanvas.getContext("2d")}measureCanvasContextContent(t,e,a=0){let i,r={left:!1,top:!1,right:!1,bottom:!1},s=parseInt(t.canvas.getAttribute("width"),10),n=parseInt(t.canvas.getAttribute("height"),10);const o=navigator.brave?1:0,h=(t,e)=>(e+1)%4==0?t>a:t>o;for(i=0;i<.5*s&&(!r.left||!r.right);i++){if(!r.left){t.getImageData(i,0,1,n).data.filter(h).length>0&&(r.left=Math.max(0,i-1))}if(!r.right){t.getImageData(s-i,0,1,n).data.filter(h).length>0&&(r.right=Math.min(s,i-1))}}for(i=0;i<.5*n&&(!r.top||!r.bottom);i++){if(!r.top){t.getImageData(0,i,s,1).data.filter(h).length>0&&(r.top=Math.max(0,i-1))}if(!r.bottom){t.getImageData(0,n-i,s,1).data.filter(h).length>0&&(r.bottom=Math.min(n,i-1))}}let l=n-r.top-r.bottom,c=s-r.right-r.left,u=e||c,d=l,m=u*d/(c*l);return e&&(u=e,d=l*m),{bounds:r,scaleFactor:m,dims:{width:u,height:d},actualDims:{width:c,height:l}}}measure(t){const e=this.normalize(t);if(e in this.measureCache)return this.measureCache[e];const a=100,i=150;this.measureCanvas.width=i,this.measureCanvas.height=i,this.measureContext.clearRect(0,0,i,i),this.measureContext.font="100px "+t.font,this.measureContext.textBaseline="middle",this.measureContext.textAlign="center",this.measureContext.fillText(t.emoji,75,75);let r=this.measureCanvasContextContent(this.measureContext,t.targetWidth,t.alphaThreshold),s=r.scaleFactor*a;return this.measureCache[e]={width:r.dims.width,height:r.dims.height,targetFontSize:s,yOffset:(75-.5*r.actualDims.height-r.bounds.top)/r.actualDims.height,xOffset:(75-.5*r.actualDims.width-r.bounds.left)/r.actualDims.width},this.measureCache[e]}render(t){t=this.normalizeInput(t);const e=this.normalize(t);if(e in this.canvasCache)return this.canvasCache[e];let a=document.createElement("canvas");const i=a.getContext("2d"),r=this.measure(t);a.setAttribute("width",r.width),a.setAttribute("height",r.height),i.clearRect(0,0,r.width,r.height),i.font=`${Math.round(r.targetFontSize)}px ${t.font}`,i.textAlign="center",i.textBaseline="middle";const s={x:.5*r.width+r.width*r.xOffset,y:.5*r.height+r.height*r.yOffset};return t.color&&(i.fillStyle=t.color),i.fillText(t.emoji,s.x,s.y),"BaseRenderer"===this.constructor.name&&(a=this.fillBackground(a,t.bgcolor)),this.canvasCache[e]=a,this.canvasCache[e]}fillBackground(t,e){if(!e||"transparent"===e||""===e)return t;const a=document.createElement("canvas"),i=a.getContext("2d"),r=t.getAttribute("width"),s=t.getAttribute("height");return a.setAttribute("width",r),a.setAttribute("height",s),i.beginPath(),i.fillStyle=e,i.fillRect(0,0,r,s),i.fill(),i.closePath(),i.drawImage(t,0,0),a}normalize(t){if((t=this.normalizeInput(t)).isError)return"PARSE_ERROR";let e=t.emoji+"_",a=[];for(const e in t)"emoji"!==e&&a.push([e,t[e]]);a.sort(((t,e)=>t[0]>e[0]?1:-1));for(const[t,i]of a){let t=String(i);[["true","t"],["false","f"],["null","n"],["sans-serif","ss"],["inside","is"],["outside","os"]].forEach((e=>t=t.replace(e[0],e[1])));for(let a=0;a<t.length;a++){const i=t.charCodeAt(a);e+=i>=48&&i<=57||i>=65&&i<=90||i>=61&&i<=122?t[a]:t.charCodeAt(a).toString(16)}}return e}normalizeInput(t){let e;if("object"==typeof t)e=t;else if("{"===t[0])try{e=JSON.parse(t)}catch(a){e={emoji:"�️",isBasicEmoji:!0,isError:!0},console.error("JSON PARSE failed on data-emoji='"+t+"'")}else e={isBasicEmoji:!0,emoji:t};e.targetWidth=e.targetWidth||this.options.targetWidth;for(const t in this.options)t in e||(e[t]=this.options[t]);return e}}{constructor(t={}){super({scale:1,rotate:null,crop:!0,...t})}render(t){if((t=this.normalizeInput(t)).isError)return super.render(t);const e=this.normalize(t);if(e in this.canvasCache)return this.canvasCache[e];const a=super.render(t),i=t.scaleX||t.scale||1,r=t.scaleY||t.scale||1,s=parseInt(a.getAttribute("width"),10),n=parseInt(a.getAttribute("height"),10),o=s*i,h=n*r;let l=document.createElement("canvas"),c=l.getContext("2d");if(l.setAttribute("width",o),l.setAttribute("height",h),"rotate"in t){const e="string"==typeof t.rotate?parseFloat(t.rotate)*Math.PI/180:t.rotate,i={tl:{x:0,y:0},tr:{x:o,y:0},br:{x:o,y:h},bl:{x:0,y:h}},r={};for(const t in i){const a=.5*o,s=.5*h,n=i[t].x,l=i[t].y;r[t]={x:a+(n-a)*Math.cos(-e)+(l-s)*Math.sin(-e),y:s-(n-a)*Math.sin(-e)+(l-s)*Math.cos(-e)}}const u=Math.min(r.tl.x,r.tr.x,r.bl.x,r.br.x),d=Math.max(r.tl.x,r.tr.x,r.bl.x,r.br.x),m=Math.min(r.tl.y,r.tr.y,r.bl.y,r.br.y),g=o+(d-o)-u,f=h+(Math.max(r.tl.y,r.tr.y,r.bl.y,r.br.y)-h)-m;l.setAttribute("width",g),l.setAttribute("height",f),c.save(),c.translate(.5*g,.5*f),c.rotate(e),c.drawImage(a,0,0,s,n,-.5*o,-.5*h,o,h),c.restore()}else c.drawImage(a,0,0,s,n,0,0,o,h);return!0===t.crop&&(l=this.cropCanvas(l,t.targetWidth,t.alphaThreshold)),"TransformedRenderer"===this.constructor.name&&(l=this.fillBackground(l,t.bgcolor)),this.canvasCache[e]=l,this.canvasCache[e]}cropCanvas(t,e,a){const i=t.getContext("2d"),r=this.measureCanvasContextContent(i,e,a),s=document.createElement("canvas"),n=s.getContext("2d");return s.setAttribute("width",r.actualDims.width),s.setAttribute("height",r.actualDims.height),n.drawImage(t,r.bounds.left,r.bounds.top,r.actualDims.width,r.actualDims.height,0,0,r.actualDims.width,r.actualDims.height),s}}{constructor(t={}){super({pixelate:0,outline:0,outlineColor:"#ff0000",outlineMode:"inside",...t})}render(t){if((t=this.normalizeInput(t)).isError)return super.render(t);const e=this.normalize(t);if(e in this.canvasCache)return this.canvasCache[e];const a=super.render(t),i=0!==parseInt(t.pixelate)&&Math.round(t.pixelate),r=t.pixelate?i*t.outline:t.outline;let s=document.createElement("canvas"),n=s.getContext("2d");if(s.setAttribute("width",a.getAttribute("width")),s.setAttribute("height",a.getAttribute("height")),i>1){const e=document.createElement("canvas"),o=e.getContext("2d"),h=1/Math.round(i),l=parseInt(s.getAttribute("width"),10),c=parseInt(s.getAttribute("height"),10);let u=l*h,d=c*h,m=l,g=c;t.outline>0&&"inside"===t.outlineMode&&(u-=2*t.outline,d-=2*t.outline,g-=2*r,m-=2*r),n.imageSmoothingEnabled=!1,e.setAttribute("width",u),e.setAttribute("height",d),o.drawImage(a,0,0,l,c,0,0,u,d),n.clearRect(0,0,l,c),n.drawImage(e,0,0,u,d,0,0,m,g)}else s=a;if(t.outline){const e=document.createElement("canvas"),a=e.getContext("2d"),i=[-1,-1,0,-1,1,-1,-1,0,1,0,-1,1,0,1,1,1],n=parseInt(s.getAttribute("width"),10)+2*r,o=parseInt(s.getAttribute("height"),10)+2*r;e.setAttribute("width",n),e.setAttribute("height",o);for(let t=0;t<i.length;t+=2)a.drawImage(s,r+i[t]*r,r+i[t+1]*r);a.globalCompositeOperation="source-in",a.fillStyle=t.outlineColor,a.fillRect(0,0,n,o),a.globalCompositeOperation="source-over",a.drawImage(s,r,r),s=e}return t.crop&&(s=this.cropCanvas(s,t.targetWidth,t.alphaThreshold)),"DecoratedRenderer"===this.constructor.name&&(s=this.fillBackground(s,t.bgcolor)),this.canvasCache[e]=s,this.canvasCache[e]}},Object.defineProperty(t,"__esModule",{value:!0})}));